graph TD
    Start([ğŸ¯ Enhanced Queries Package<br/>From Query Preprocessing<br/>7-10 optimized queries]) --> ModeSelect{ğŸ¨ Select Retrieval Mode}
    
    ModeSelect --> Fast[âš¡ FAST MODE<br/>~4 seconds<br/>3 docs needed]
    ModeSelect --> Standard[ğŸ“Š STANDARD MODE<br/>~10 seconds<br/>7 docs needed]
    ModeSelect --> Thorough[ğŸ”¬ THOROUGH MODE<br/>~20 seconds<br/>15 docs needed]
    
    Fast --> FastVec[Single Vector Search<br/>Main query only<br/>Top 3 results]
    FastVec --> FastOut[âš¡ Fast Output]
    
    Standard --> StdStage1[ğŸ“ Stage 1: Parallel Hybrid Retrieval<br/>ThreadPoolExecutor max_workers=2]
    
    StdStage1 --> StdVec[Thread 1: Vector Search<br/>Main query â†’ Top 20]
    StdStage1 --> StdBM25[Thread 2: BM25 Search<br/>Main query â†’ Top 20]
    
    StdVec --> StdDB[(ğŸ—„ï¸ Database<br/>Multi-Vector Access)]
    StdBM25 --> StdDB
    
    StdDB --> StdVec1[Query full text embeddings]
    StdDB --> StdVec2[Query first sentence embeddings]
    StdDB --> StdVec3[Query keywords embeddings]
    
    StdVec1 --> StdFusion
    StdVec2 --> StdFusion
    StdVec3 --> StdFusion["ğŸ”„ Reciprocal Rank Fusion<br/>RRF combines rankings<br/>Score = 1/(k+rank)"]
    
    StdBM25 --> StdFusion
    
    StdFusion --> StdTop[ğŸ“‹ Top 15 Combined Results]
    
    StdTop --> StdStage2[ğŸ“ Stage 2: Cross-Encoder Reranking<br/>ms-marco-MiniLM-L-6-v2]
    
    StdStage2 --> StdRerank[Deep semantic matching<br/>Query-document pairs<br/>Batch processing]
    
    StdRerank --> StdOut[ğŸ“Š Standard Output<br/>Top 7 reranked]
    
    Thorough --> ThorStage1[ğŸ“ Stage 1: Parallel Query Enhancement<br/>ThreadPoolExecutor max_workers=3]
    
    ThorStage1 --> ThorSub[Thread 1: Sub-queries<br/>Complex decomposition]
    ThorStage1 --> ThorVar[Thread 2: Search variations<br/>Multiple phrasings]
    ThorStage1 --> ThorHyp[Thread 3: Hypothetical doc<br/>Expected answer template]
    
    ThorSub --> ThorQueries[ğŸ“¦ 7 Query Variations<br/>Original + 5 sub + 1 hyp]
    ThorVar --> ThorQueries
    ThorHyp --> ThorQueries
    
    ThorQueries --> ThorStage2[ğŸ“ Stage 2: Parallel Multi-Source Retrieval<br/>ThreadPoolExecutor max_workers=4]
    
    ThorStage2 --> ThorLoop[For each of 5 queries:<br/>Launch 2 parallel searches]
    
    ThorLoop --> ThorV[Vector Search<br/>Top 10 per query]
    ThorLoop --> ThorB[BM25 Search<br/>Top 10 per query]
    
    ThorV --> ThorDB[(ğŸ—„ï¸ Database<br/>All 3 Vector Types)]
    ThorB --> ThorDB
    
    ThorDB --> ThorCollect[ğŸ“Š Collect All Results<br/>~100 candidate docs]
    
    ThorCollect --> ThorDedup[ğŸ” Deduplication<br/>Remove exact duplicates<br/>Keep unique ~50 docs]
    
    ThorDedup --> ThorStage3[ğŸ“ Stage 3: Multi-Vector Scoring<br/>Late Interaction]
    
    ThorStage3 --> ThorSentence[Split each doc into sentences<br/>Batch encode ALL sentences<br/>paraphrase-MiniLM-L3-v2]
    
    ThorSentence --> ThorMax[For each doc:<br/>Max similarity across sentences<br/>Query vs each sentence]
    
    ThorMax --> ThorTop30[ğŸ“‹ Top 30 by multi-vec score]
    
    ThorTop30 --> ThorStage4[ğŸ“ Stage 4: Cross-Encoder Reranking<br/>Deep semantic validation]
    
    ThorStage4 --> ThorCross[Query-doc pairs<br/>Batch prediction<br/>ms-marco-MiniLM]
    
    ThorCross --> ThorTop20[ğŸ“‹ Top 20 reranked]
    
    ThorTop20 --> ThorStage5[ğŸ“ Stage 5: Diversity Filter<br/>Remove near-duplicates]
    
    ThorStage5 --> ThorDiversity[Cosine similarity threshold<br/>0.85 cutoff<br/>Keep diverse docs]
    
    ThorDiversity --> ThorOut[ğŸ”¬ Thorough Output<br/>Top 15 diverse + accurate]
    
    FastOut --> Final[âœ… Final Ranked Documents]
    StdOut --> Final
    ThorOut --> Final
    
    Final --> Meta[ğŸ“Š Metadata Attached]
    
    Meta --> M1[Source file name]
    Meta --> M2[Relevance score]
    Meta --> M3[Chunk text preview]
    Meta --> M4[Rerank score if used]
    Meta --> M5[Multi-vec score if used]
    
    M1 --> Generation
    M2 --> Generation
    M3 --> Generation
    M4 --> Generation
    M5 --> Generation[(ğŸ¯ Ready for Answer Generation<br/>Ranked, scored, diverse documents<br/>With full metadata)]
    
    Generation --> Tech[ğŸ”§ Technical Components]
    
    Tech --> T1[Embedder: paraphrase-MiniLM-L3-v2<br/>384 dims, 50MB]
    Tech --> T2[Reranker: ms-marco-MiniLM-L-6-v2<br/>Cross-encoder, 90MB]
    Tech --> T3[BM25: BM25Plus algorithm<br/>Keyword matching]
    Tech --> T4[Threading: ThreadPoolExecutor<br/>Parallel execution]
    Tech --> T5[Database: SQLite with thread lock<br/>Thread-safe operations]
    Tech --> T6[RRF: Reciprocal Rank Fusion<br/>k=60 parameter]
    
    style Start fill:#e3f2fd
    style ModeSelect fill:#fff9c4
    style Fast fill:#c8e6c9
    style Standard fill:#ffe0b2
    style Thorough fill:#f8bbd0
    
    style StdStage1 fill:#ce93d8
    style StdStage2 fill:#ba68c8
    style StdFusion fill:#ab47bc
    
    style ThorStage1 fill:#90caf9
    style ThorStage2 fill:#64b5f6
    style ThorStage3 fill:#42a5f5
    style ThorStage4 fill:#2196f3
    style ThorStage5 fill:#1e88e5
    
    style Final fill:#a5d6a7
    style Generation fill:#81c784
    style Tech fill:#90a4ae
    
    style FastOut fill:#c8e6c9
    style StdOut fill:#ffe0b2
    style ThorOut fill:#f8bbd0
    
    style StdDB fill:#fff9c4
    style ThorDB fill:#fff9c4
